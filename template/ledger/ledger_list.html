{% extends "includes/base.html" %}
{% load static %}

{% block body_content %}
<div class="nk-content nk-content-fluid">
  <div class="container-xl wide-xl">
    <div class="nk-content-body">
      <div class="nk-block-head nk-block-head-sm">
        <div class="nk-block-between">
          <div class="nk-block-head-content">
            <h3 class="nk-block-title page-title">Ledger List</h3>
          </div>
          <div class="nk-block-head-content">
            <div class="toggle-wrap nk-block-tools-toggle">
              <a href="#" class="btn btn-icon btn-trigger toggle-expand me-n1" data-target="pageMenu">
                <em class="icon ni ni-menu-alt-r"></em>
              </a>
              <div class="toggle-expand-content" data-content="pageMenu">
                <ul class="nk-block-tools g-3">
                  <li>
                    <div class="drodown">
                      <a href="#" class="btn btn-white btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                        <em class="icon ni ni-download-cloud"></em><span>Export</span>
                      </a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <ul class="link-list-opt no-bdr">
                          <li><a href="#" id="export-csv"><em class="icon ni ni-file-csv"></em><span>Export CSV</span></a></li>
                          <li><a href="#" id="export-excel"><em class="icon ni ni-file-excel"></em><span>Export Excel</span></a></li>
                          <li><a href="#" id="export-pdf"><em class="icon ni ni-file-pdf"></em><span>Export PDF</span></a></li>
                        </ul>
                      </div>
                    </div>
                  </li>
                  <li class="nk-block-tools-opt">
                    <a href="{% url 'create-ledger' %}" class="btn btn-primary">
                      <em class="icon ni ni-plus"></em><span>Add Ledger</span>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="nk-block">
        <div class="card card-stretch">
          <div class="card-inner">
            <table id="ledgerTable" class="datatable-init table" style="width:100%">
              <thead>
                <tr>
                  <th><div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="selectAll">
                    <label class="custom-control-label" for="selectAll"></label>
                  </div></th>
                  <th>Ledger Name</th>
                  <th>Group</th>
                  <th>Current Balance</th>
                  <th>Contact</th>
                  <th>GSTIN</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for ledger in ledgers %}
                <tr>
                  <td>
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="lid{{ ledger.id }}">
                      <label class="custom-control-label" for="lid{{ ledger.id }}"></label>
                    </div>
                  </td>
                  <td>
                    <a href="#">
                      <span class="tb-lead">{{ ledger.name }}</span>
                    </a>
                  </td>
                  <td>
                    <span class="badge badge-dim bg-primary">{{ ledger.ledger_group|title }}</span>
                  </td>
                  <td>
                    {% if ledger.current_balance_type == 'debit' %}
                    <span class="tb-amount">{{ ledger.current_balance_amount }} <span class="currency">Dr</span></span>
                    {% else %}
                    <span class="tb-amount">{{ ledger.current_balance_amount }} <span class="currency">Cr</span></span>
                    {% endif %}
                  </td>
                  <td>{{ ledger.mobile_number }}</td>
                  <td>{{ ledger.gst_no }}</td>
                  <td class="text-end">
                    <div class="dropdown">
                      <a href="#" class="dropdown-toggle btn btn-icon btn-trigger" data-bs-toggle="dropdown">
                        <em class="icon ni ni-more-h"></em>
                      </a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <ul class="link-list-opt no-bdr">
                          <li>
                            <a href="#">
                              <em class="icon ni ni-eye"></em><span>View Details</span>
                            </a>
                          </li>
                          <li>
                            <a href="#">
                              <em class="icon ni ni-edit"></em><span>Edit</span>
                            </a>
                          </li>
                          <li>
                            <a href="#">
                              <em class="icon ni ni-repeat"></em><span>Transactions</span>
                            </a>
                          </li>
                          <li>
                            <a href="#" class="delete-ledger" data-id="{{ ledger.id }}">
                              <em class="icon ni ni-trash"></em><span>Delete</span>
                            </a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLedgerModal" tabindex="-1" role="dialog" aria-labelledby="deleteLedgerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteLedgerModalLabel">Confirm Delete</h5>
        <a href="#" class="close" data-bs-dismiss="modal" aria-label="Close">
          <em class="icon ni ni-cross"></em>
        </a>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this ledger? This action cannot be undone and may affect financial records.</p>
      </div>
      <div class="modal-footer">
        <a href="#" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</a>
        <a href="#" id="confirmDelete" class="btn btn-danger">Delete</a>
      </div>
    </div>
  </div>
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block foot_script %}
<!-- Include the common DataTable initialization JS -->
<script src="{% static 'js/common/datatable-init.js' %}"></script>
<script>
  $(document).ready(function() {
    // Prevent DataTable reinitialization
    if (!$.fn.DataTable.isDataTable('#ledgerTable')) {
      var table = initializeDataTable('#ledgerTable', {
        // Any ledger table specific options
        searchPlaceholder: "Search ledgers...",
        columnDefs: [
          { orderable: false, targets: [0, 6] },
          { type: "num-fmt", targets: 3 }
        ]
      });
    } else {
      var table = $('#ledgerTable').DataTable();
    }
    
    // Select All checkbox
    $("#selectAll").on("click", function() {
      if($(this).is(":checked")) {
        $('.custom-control-input').prop('checked', true);
      } else {
        $('.custom-control-input').prop('checked', false);
      }
    });

    // Export buttons
    $('#export-csv').on('click', function(e) {
      e.preventDefault();
      table.button('.buttons-csv').trigger();
    });

    $('#export-excel').on('click', function(e) {
      e.preventDefault();
      table.button('.buttons-excel').trigger();
    });

    $('#export-pdf').on('click', function(e) {
      e.preventDefault();
      table.button('.buttons-pdf').trigger();
    });

    // Delete ledger
    $('.delete-ledger').on('click', function(e) {
      e.preventDefault();
      var ledgerId = $(this).data('id');
      $('#confirmDelete').data('id', ledgerId);
      $('#deleteLedgerModal').modal('show');
    });

    $('#confirmDelete').on('click', function(e) {
      e.preventDefault();
      var ledgerId = $(this).data('id');
      
      $.ajax({
        url: "#",
        type: "POST",
        data: {
          'ledger_id': ledgerId,
          'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
          if(response.status === "success") {
            $('#deleteLedgerModal').modal('hide');
            // Show success notification
            toastr.success(response.message);
            // Reload the table or remove the row
            setTimeout(function() {
              window.location.reload();
            }, 1000);
          } else {
            toastr.error(response.message);
          }
        },
        error: function(xhr, errmsg, err) {
          toastr.error("Error occurred while deleting ledger.");
        }
      });
    });
  });
</script>
{% endblock %}